# ğŸ”§ Dockerfile Backend Node.js - Version CorrigÃ©e OptimisÃ©e
FROM node:18-alpine AS base

# ğŸ“¦ Installation des dÃ©pendances systÃ¨me nÃ©cessaires
RUN apk add --no-cache \
    openssl \
    wget \
    curl \
    netcat-openbsd \
    postgresql-client \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# ğŸ“‹ Ã‰tape 1: Installation des dÃ©pendances
FROM base AS deps

# Copier les fichiers de configuration des dÃ©pendances
COPY package*.json ./

# Installation des dÃ©pendances de production et dev (pour Prisma)
RUN npm ci --include=dev && npm cache clean --force

# ğŸ—ï¸ Ã‰tape 2: Build et prÃ©paration
FROM base AS builder

WORKDIR /app

# Copier les dÃ©pendances installÃ©es
COPY --from=deps /app/node_modules ./node_modules

# Copier le schÃ©ma Prisma en premier (pour le cache Docker)
COPY prisma ./prisma

# GÃ©nÃ©rer le client Prisma
RUN npx prisma generate

# Copier le reste du code source
COPY . .

# Installer uniquement les dÃ©pendances de production
RUN npm ci --only=production && npm cache clean --force

# ğŸš€ Ã‰tape 3: Production - Image finale
FROM base AS runner

WORKDIR /app

# Variables d'environnement de production
ENV NODE_ENV=production
ENV PORT=4002

# ğŸ‘¤ CrÃ©er un utilisateur non-root pour la sÃ©curitÃ©
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs nodejs

# ğŸ“¦ Copier les dÃ©pendances de production
COPY --from=builder /app/node_modules ./node_modules

# ğŸ“¦ Copier le client Prisma gÃ©nÃ©rÃ©
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# ğŸ“ Copier le code source et la configuration
COPY --chown=nodejs:nodejs . .

# ğŸ“ CrÃ©er les dossiers nÃ©cessaires avec les bonnes permissions
RUN mkdir -p /app/uploads /app/logs /app/tmp && \
    chown -R nodejs:nodejs /app/uploads /app/logs /app/tmp

# ğŸ”§ Rendre les scripts exÃ©cutables
RUN chmod +x /app/scripts/*.sh

# ğŸ‘¤ Utiliser l'utilisateur non-root
USER nodejs

# ğŸ” Health check optimisÃ©
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:4002/health || exit 1

# ğŸš€ Exposer le port
EXPOSE 4002

# ğŸ¯ Point d'entrÃ©e et commande de dÃ©marrage
ENTRYPOINT ["/app/scripts/docker-entrypoint.sh"]
CMD ["npm", "start"]
