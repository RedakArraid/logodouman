const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');
const db = new PrismaClient();

async function main() {
  console.log('üöÄ D√©but de la migration avec donn√©es de test...');

  try {
    // 1. Nettoyer les donn√©es existantes (ordre important pour les relations)
    console.log('üßπ Nettoyage des donn√©es existantes...');
    await db.orderItem.deleteMany();
    await db.payment.deleteMany();
    await db.shipping.deleteMany();
    await db.order.deleteMany();
    await db.inventory.deleteMany();
    await db.notification.deleteMany();
    await db.promotion.deleteMany();
    await db.address.deleteMany();
    await db.customer.deleteMany();
    await db.product.deleteMany();
    await db.category.deleteMany();
    await db.user.deleteMany();

    // 2. Cr√©er un utilisateur admin
    console.log('üë§ Cr√©ation de l\'utilisateur admin...');
    const adminPassword = await bcrypt.hash('admin123', 12);
    const admin = await db.user.create({
      data: {
        email: 'admin@logodouman.com',
        password: adminPassword,
        name: 'Administrateur LogoDouman',
        role: 'admin'
      }
    });
    console.log('‚úÖ Admin cr√©√©:', admin.email);

    // 3. Cr√©er les cat√©gories
    console.log('üè∑Ô∏è Cr√©ation des cat√©gories...');
    const categories = await Promise.all([
      db.category.create({
        data: {
          id: 'luxury-cat-001',
          name: 'Luxe',
          icon: 'üíé',
          image: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?w=400&h=400&fit=crop&crop=center',
          description: 'Sacs haut de gamme en cuir premium et finitions dor√©es',
          status: 'active'
        }
      }),
      db.category.create({
        data: {
          id: 'vintage-cat-002',
          name: 'Vintage',
          icon: 'üï∞Ô∏è',
          image: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=400&fit=crop&crop=center',
          description: 'Designs r√©tro et motifs g√©om√©triques tendance',
          status: 'active'
        }
      }),
      db.category.create({
        data: {
          id: 'business-cat-003',
          name: 'Business',
          icon: 'üíº',
          image: 'https://images.unsplash.com/photo-1581605405669-fcdf81165afa?w=400&h=400&fit=crop&crop=center',
          description: 'Sacs professionnels et fonctionnels pour le travail',
          status: 'active'
        }
      }),
      db.category.create({
        data: {
          id: 'casual-cat-005',
          name: 'Casual',
          icon: 'üëú',
          image: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=400&fit=crop&crop=center',
          description: 'Sacs pratiques et confortables pour tous les jours',
          status: 'active'
        }
      })
    ]);
    console.log('‚úÖ Cat√©gories cr√©√©es:', categories.length);

    // 4. Cr√©er les produits
    console.log('üì¶ Cr√©ation des produits...');
    const products = [
      {
        name: "Sac √† main verni brillant avec anneau de levage",
        price: 10000000, // 100,000 FCFA en centimes
        categoryId: "luxury-cat-001",
        image: "https://images.unsplash.com/photo-1584917865442-de89df76afd3?w=400&h=400&fit=crop&crop=center",
        description: "Sac √† main √©l√©gant avec finition vernie brillante et anneau de levage dor√© pour femme",
        stock: 12,
        status: "active",
        sku: "C05N001",
        material: "Cuir PU",
        lining: "Polyester",
        dimensions: "25 x 18 x 12 cm",
        weight: 0.7,
        shape: "Rectangle",
        styles: ["Mode", "Luxe", "√âl√©gant"],
        pattern: "Solide",
        decoration: "Anneau dor√©",
        closure: "Fermeture √©clair",
        handles: "Double poign√©e",
        season: "Toutes saisons",
        occasion: "Soir√©e",
        features: ["R√©sistant", "√âl√©gant"],
        colors: ["Noir", "Rouge", "Beige"],
        gender: "Femme",
        ageGroup: "Adulte"
      },
      {
        name: "Sac imprim√© g√©om√©trique vintage l√©ger tendance",
        price: 8000000, // 80,000 FCFA en centimes
        categoryId: "vintage-cat-002",
        image: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=400&fit=crop&crop=center",
        description: "Sac tendance avec motifs g√©om√©triques vintage, l√©ger et pratique pour un look moderne",
        stock: 8,
        status: "active",
        sku: "C05N002",
        material: "Toile enduite",
        lining: "Coton",
        dimensions: "30 x 25 x 8 cm",
        weight: 0.4,
        shape: "Rectangle",
        styles: ["Vintage", "D√©contract√©", "Tendance"],
        pattern: "G√©om√©trique",
        decoration: "Motifs imprim√©s",
        closure: "Fermeture √©clair",
        handles: "Bandouli√®re r√©glable",
        season: "Printemps-√ât√©",
        occasion: "Quotidien",
        features: ["L√©ger", "Pratique"],
        colors: ["Multicolore", "Beige", "Marron"],
        gender: "Femme",
        ageGroup: "Jeune Adulte"
      },
      {
        name: "Sac √† dos d'ordinateur r√©sistant √† l'eau antivol",
        price: 12000000, // 120,000 FCFA en centimes
        categoryId: "business-cat-003",
        image: "https://images.unsplash.com/photo-1581605405669-fcdf81165afa?w=400&h=400&fit=crop&crop=center",
        description: "Sac √† dos professionnel antivol avec protection contre l'eau pour ordinateur portable",
        stock: 15,
        status: "active",
        sku: "C05N003",
        material: "Nylon renforc√©",
        lining: "Polyester",
        dimensions: "45 x 30 x 15 cm",
        weight: 1.2,
        shape: "Ergonomique",
        styles: ["Business", "Moderne", "Fonctionnel"],
        pattern: "Solide",
        decoration: "Logo discret",
        closure: "Fermeture √©clair",
        handles: "Bretelles rembourr√©es",
        season: "Toutes saisons",
        occasion: "Travail",
        features: ["Imperm√©able", "Antivol", "Port USB", "Compartiment ordinateur"],
        colors: ["Noir", "Gris", "Bleu marine"],
        gender: "Unisexe",
        ageGroup: "Adulte"
      },
      {
        name: "Sac bandouli√®re compact quotidien",
        price: 6000000, // 60,000 FCFA en centimes
        categoryId: "casual-cat-005",
        image: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=400&fit=crop&crop=center",
        description: "Sac bandouli√®re compact et pratique pour le quotidien, design moderne et fonctionnel",
        stock: 20,
        status: "active",
        sku: "C05N006",
        material: "Coton canvas",
        lining: "Polyester",
        dimensions: "20 x 15 x 8 cm",
        weight: 0.3,
        shape: "Compact",
        styles: ["D√©contract√©", "Moderne", "Pratique"],
        pattern: "Solide",
        decoration: "Logo brod√©",
        closure: "Fermeture √©clair",
        handles: "Bandouli√®re ajustable",
        season: "Toutes saisons",
        occasion: "Quotidien",
        features: ["Compact", "L√©ger", "Pratique"],
        colors: ["Beige", "Kaki", "Noir"],
        gender: "Unisexe",
        ageGroup: "Jeune Adulte"
      }
    ];

    const createdProducts = [];
    for (const productData of products) {
      const product = await db.product.create({ data: productData });
      createdProducts.push(product);
    }
    console.log('‚úÖ Produits cr√©√©s:', createdProducts.length);

    // 5. Cr√©er l'inventaire pour chaque produit
    console.log('üìä Cr√©ation de l\'inventaire...');
    for (const product of createdProducts) {
      await db.inventory.create({
        data: {
          productId: product.id,
          quantity: product.stock,
          reserved: 0,
          available: product.stock,
          lowStockThreshold: 10
        }
      });
    }
    console.log('‚úÖ Inventaire cr√©√© pour tous les produits');

    // 6. Cr√©er des clients de test
    console.log('üë• Cr√©ation des clients de test...');
    const customers = await Promise.all([
      db.customer.create({
        data: {
          email: 'marie.dupont@email.com',
          firstName: 'Marie',
          lastName: 'Dupont',
          phone: '+225 07 12 34 56 78',
          totalSpent: 18000000, // 180,000 FCFA en centimes
          loyaltyPoints: 140,
          status: 'active'
        }
      }),
      db.customer.create({
        data: {
          email: 'jean.kouassi@email.com',
          firstName: 'Jean',
          lastName: 'Kouassi',
          phone: '+225 05 98 76 54 32',
          totalSpent: 10000000, // 100,000 FCFA en centimes
          loyaltyPoints: 75,
          status: 'active'
        }
      })
    ]);

    // 7. Cr√©er des adresses pour les clients
    console.log('üè† Cr√©ation des adresses...');
    await Promise.all([
      db.address.create({
        data: {
          customerId: customers[0].id,
          street: '15 Rue des Palmiers',
          city: 'Abidjan',
          postalCode: '08 BP 1234',
          country: 'C√¥te d\'Ivoire',
          isDefault: true
        }
      }),
      db.address.create({
        data: {
          customerId: customers[1].id,
          street: '22 Avenue de la R√©publique',
          city: 'Bouak√©',
          postalCode: '01 BP 5678',
          country: 'C√¥te d\'Ivoire',
          isDefault: true
        }
      })
    ]);

    // 8. Cr√©er des promotions de test
    console.log('üéâ Cr√©ation des promotions...');
    const promotions = await Promise.all([
      db.promotion.create({
        data: {
          code: 'WELCOME20',
          name: 'Bienvenue - 20% de r√©duction',
          description: 'Offre de bienvenue pour les nouveaux clients',
          type: 'PERCENTAGE',
          value: 20, // 20%
          minAmount: 6500000, // 65,000 FCFA minimum
          maxUses: 100,
          usedCount: 15,
          startDate: new Date('2024-01-01'),
          endDate: new Date('2024-12-31'),
          isActive: true
        }
      }),
      db.promotion.create({
        data: {
          code: 'FREESHIP',
          name: 'Livraison gratuite',
          description: 'Livraison gratuite pour toute commande',
          type: 'FREE_SHIPPING',
          value: 0,
          minAmount: 3300000, // 33,000 FCFA minimum
          maxUses: null, // illimit√©
          usedCount: 42,
          startDate: new Date('2024-01-01'),
          endDate: new Date('2024-06-30'),
          isActive: true
        }
      })
    ]);

    // 9. Cr√©er des commandes de test
    console.log('üõí Cr√©ation des commandes de test...');
    const orders = [];

    // Commande 1
    const order1 = await db.order.create({
      data: {
        customerId: customers[0].id,
        userId: admin.id,
        status: 'CONFIRMED',
        totalAmount: 10000000, // 100,000 FCFA
        taxAmount: 0,
        shippingCost: 0,
        discountAmount: 0,
        promotionCode: 'FREESHIP'
      }
    });
    orders.push(order1);

    // Items pour la commande 1
    await db.orderItem.create({
      data: {
        orderId: order1.id,
        productId: createdProducts[0].id,
        quantity: 1,
        unitPrice: 150000,
        totalPrice: 150000
      }
    });

    // Commande 2
    const order2 = await db.order.create({
      data: {
        customerId: customers[1].id,
        userId: admin.id,
        status: 'PENDING',
        totalAmount: 130000, // 130.00‚Ç¨
        taxAmount: 0,
        shippingCost: 0,
        discountAmount: 20000, // 20.00‚Ç¨ de r√©duction
        promotionCode: 'WELCOME20'
      }
    });
    orders.push(order2);

    // Items pour la commande 2
    await db.orderItem.create({
      data: {
        orderId: order2.id,
        productId: createdProducts[1].id,
        quantity: 1,
        unitPrice: 125000,
        totalPrice: 125000
      }
    });

    // 10. Cr√©er les paiements
    console.log('üí≥ Cr√©ation des paiements...');
    await Promise.all([
      db.payment.create({
        data: {
          orderId: order1.id,
          amount: 150000,
          method: 'CARD',
          status: 'COMPLETED',
          transactionId: 'txn_1234567890',
          gateway: 'stripe'
        }
      }),
      db.payment.create({
        data: {
          orderId: order2.id,
          amount: 130000,
          method: 'BANK_TRANSFER',
          status: 'PENDING',
          transactionId: 'txn_0987654321',
          gateway: 'bank'
        }
      })
    ]);

    // 11. Cr√©er les informations de livraison
    console.log('üì¶ Cr√©ation des livraisons...');
    await Promise.all([
      db.shipping.create({
        data: {
          orderId: order1.id,
          method: 'STANDARD',
          status: 'DELIVERED',
          trackingCode: 'LOG123456789',
          carrier: 'DHL',
          estimatedDelivery: new Date('2024-02-15'),
          actualDelivery: new Date('2024-02-14')
        }
      }),
      db.shipping.create({
        data: {
          orderId: order2.id,
          method: 'EXPRESS',
          status: 'PROCESSING',
          trackingCode: 'LOG987654321',
          carrier: 'UPS',
          estimatedDelivery: new Date('2024-03-10')
        }
      })
    ]);

    // 12. Cr√©er des notifications
    console.log('üîî Cr√©ation des notifications...');
    await Promise.all([
      db.notification.create({
        data: {
          type: 'STOCK_ALERT',
          title: 'Stock faible',
          message: 'Le produit "Sac imprim√© g√©om√©trique vintage" a un stock faible (8 unit√©s)',
          isRead: false,
          userId: admin.id,
          metadata: { productId: createdProducts[1].id }
        }
      }),
      db.notification.create({
        data: {
          type: 'ORDER_STATUS',
          title: 'Nouvelle commande',
          message: 'Une nouvelle commande a √©t√© pass√©e par Jean Kouassi',
          isRead: false,
          userId: admin.id,
          metadata: { orderId: order2.id }
        }
      })
    ]);

    console.log('\nüéâ Migration termin√©e avec succ√®s !');
    console.log('\nüìä R√©sum√© des donn√©es cr√©√©es :');
    console.log(`   üë§ Utilisateurs: 1 admin`);
    console.log(`   üè∑Ô∏è Cat√©gories: ${categories.length}`);
    console.log(`   üì¶ Produits: ${createdProducts.length}`);
    console.log(`   üë• Clients: ${customers.length}`);
    console.log(`   üõí Commandes: ${orders.length}`);
    console.log(`   üéâ Promotions: ${promotions.length}`);
    console.log(`   üîî Notifications: 2`);
    
    console.log('\nüîë Compte admin cr√©√© :');
    console.log(`   Email: admin@logodouman.com`);
    console.log(`   Mot de passe: admin123`);
    
    console.log('\nüöÄ Vous pouvez maintenant :');
    console.log(`   ‚Ä¢ Vous connecter sur: http://localhost:3000/admin/login`);
    console.log(`   ‚Ä¢ Voir le site: http://localhost:3000`);
    console.log(`   ‚Ä¢ Tester l'API: http://localhost:4002`);

  } catch (error) {
    console.error('‚ùå Erreur lors de la migration:', error);
    throw error;
  } finally {
    await db.$disconnect();
  }
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur fatale:', e);
    process.exit(1);
  });
